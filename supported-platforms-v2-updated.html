<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CynviaOne â€” Supported platforms (Updated)</title>

<!-- Roboto + Material Symbols Rounded -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,600,1,0" rel="stylesheet">

<style>
:root{--bg:#fbf9fb;--card:#e6e4e7;--muted:#6d6c6d;--title:#0b0b0b;--accent:#3f5f90;--radius:18px;--max-w:420px;--icon-size-lg:28px;--icon-slot:56px;--gap-22:18px;--danger:#e24b4b}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Roboto",system-ui,Arial;color:var(--title);-webkit-font-smoothing:antialiased}
.wrap{max-width:var(--max-w);margin:8px auto;padding:8px 12px 40px}
.material-rounded{font-family: 'Material Symbols Rounded';font-variation-settings: "FILL" 1, "wght" 600, "GRAD" 0, "opsz" 40;display:inline-block;line-height:1;vertical-align:middle}
.icon-md{font-size:var(--icon-size-lg)}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}.left{display:flex;align-items:center;gap:8px}
.btn-close{background:transparent;border:0;padding:0;margin:0;font-size:18px;cursor:pointer;color:var(--title);display:inline-flex;align-items:center;justify-content:center}
.logo{font-weight:700;font-size:20px;line-height:1.05}.logo .one{color:var(--accent);font-weight:600}
.actions{display:flex;gap:12px;align-items:center}.action-icon{background:transparent;border:0;padding:6px;font-size:24px;cursor:pointer;color:var(--title)}

/* page header */
.page-header{padding:16px 2px 20px}.page-header h1{margin:0 0 8px;font-size:36px;font-weight:700;line-height:1.05}
.page-header .subtitle{margin:0 0 12px;font-size:16px;font-weight:600;color:var(--title)}
.page-header .description{margin:0;font-size:14px;line-height:1.4;color:var(--title);opacity:0.85;font-weight:400}

/* card list */
.profile-section{background:var(--card);border-radius:var(--radius);padding:6px;margin-bottom:var(--gap-22)}
.profile-item{display:flex;align-items:center;gap:14px;padding:14px;cursor:default;transition:all 0.15s ease;position:relative}
.profile-item + .profile-item::before{content:"";display:block;position:absolute;left:0;right:0;height:2px;top:0;background:var(--bg)}
.icon{width:var(--icon-slot);height:var(--icon-slot);display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:12px;background:#fff;box-shadow:0 0 0 1px rgba(0,0,0,0.03);position:relative;overflow:visible}
.icon img{max-width:36px;max-height:36px;display:block}
.icon .overlay-tick{position:absolute;right:-6px;bottom:-6px;background:#12c76a;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
.profile-item .content{flex:1;min-width:0}
.profile-item h3{margin:0 0 3px;font-size:16px;font-weight:700}
.profile-item p{margin:0;font-size:13px;color:var(--muted);font-weight:500}
.btn-link{padding:8px 16px;border-radius:999px;border:none;font-size:14px;font-weight:700;cursor:pointer;transition:all .12s ease;background:#000;color:#fff}
.btn-unlink{padding:8px 14px;border-radius:999px;border:1px solid rgba(0,0,0,0.08);font-size:14px;font-weight:700;cursor:pointer;transition:all .12s ease;background:transparent;color:var(--title)}

/* about/help items - no white box around icons */
.simple-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;background:transparent;margin-top:8px}
.simple-row .icon{background:transparent;box-shadow:none;border-radius:8px;width:44px;height:44px;display:flex;align-items:center;justify-content:center}
.simple-row h3{margin:0;font-size:16px;font-weight:700}
.simple-row p{margin:0;font-size:13px;color:var(--muted)}

/* modal (custom confirmation) */
.modal-backdrop{position:fixed;inset:0;background:rgba(8,8,10,0.35);display:none;align-items:center;justify-content:center;z-index:1200;padding:16px}
.modal{width:100%;max-width:420px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.18);color:var(--title)}
.modal h2{margin:0 0 8px;font-size:20px}
.modal p{margin:0 0 16px;color:var(--muted);font-weight:500}
.modal .row{display:flex;gap:12px;justify-content:flex-end}
.btn-cancel{padding:8px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:transparent;font-weight:700;cursor:pointer}
.btn-confirm{padding:8px 14px;border-radius:12px;border:0;background:var(--danger);color:#fff;font-weight:700;cursor:pointer}

/* loading */
.loading-container {display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;margin:12px 0}
.spinner {width:34px;height:34px;border:4px solid transparent;border-top:4px solid #000;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* responsive */
@media (max-width:420px){:root{--max-w:100%}.wrap{padding-left:10px;padding-right:10px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <button class="btn-close" aria-label="Go back" onclick="goBack()">
          <span class="material-rounded icon-md">arrow_back</span>
        </button>
        <div class="logo">Cynvia<span class="one">One</span></div>
      </div>
      <div class="actions">
        <button class="action-icon" title="Help" aria-label="Help" onclick="window.location.href='mailto:support.cynviaone@outlook.com'">
          <span class="material-rounded icon-md">help</span>
        </button>
      </div>
    </div>

    <div class="page-header">
      <h1>Supported platforms</h1>
      <p class="subtitle">Manage and connect your account with third-party services.</p>
      <p class="description">Linking supported platforms allows you to sign in faster, sync data, and enhance your experience across different apps and services.</p>
    </div>

    <!-- Loading -->
    <div id="loadingContainer" class="loading-container" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
    </div>

    <!-- Main -->
    <div id="mainContent" style="display:none;">
      <div class="profile-section" id="platformList">
        <!-- platform items injected by JS -->
      </div>

      <div class="more">looking for something else?</div>

      <div class="simple-row" onclick="window.location.href='about.html'" role="button" style="cursor:pointer">
        <div class="icon"><span class="material-rounded icon-md">info</span></div>
        <div style="flex:1"><h3>About CynviaOne</h3><p>Learn more about CynviaOne</p></div>
      </div>

      <div class="simple-row" onclick="window.location.href='mailto:support.cynviaone@outlook.com?subject=Feedback'" role="button" style="cursor:pointer">
        <div class="icon"><span class="material-rounded icon-md">feedback</span></div>
        <div style="flex:1"><h3>Send feedback</h3><p>Share your thoughts with us</p></div>
      </div>
    </div>
  </div>

  <!-- Confirmation modal for unlinking -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h2 id="modalTitle">Unlink account?</h2>
      <p id="modalMessage">Are you sure you want to unlink this platform from your account? Some features may stop working.</p>
      <div class="row">
        <button id="modalCancel" class="btn-cancel">Cancel</button>
        <button id="modalConfirm" class="btn-confirm">Unlink</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // Firebase config (same as your uploaded file)
  const firebaseConfig = {
    apiKey: "AIzaSyDaRo6aKcg5Tju7spWUtLKOUBEItUpgF90",
    authDomain: "ouruiofficial.firebaseapp.com",
    projectId: "ouruiofficial",
    storageBucket: "ouruiofficial.firebasestorage.app",
    messagingSenderId: "513335403025",
    appId: "1:513335403025:web:b965e1187d5386d52d87b0",
    measurementId: "G-X5QWNP8DMK"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const LOGO_URLS = {
    google: 'https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg',
    microsoft: 'https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg',
    github: 'https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg',
    apple: 'https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg'
  };

  const PLATFORM_LIST = [
    { id: 'google.com', label: 'Google', company: 'Google LLC', logoKey: 'google', providerFactory: () => new firebase.auth.GoogleAuthProvider() },
    { id: 'microsoft.com', label: 'Microsoft', company: 'Microsoft Corporation', logoKey: 'microsoft', providerFactory: () => new firebase.auth.OAuthProvider('microsoft.com') },
    { id: 'github.com', label: 'GitHub', company: 'GitHub, Inc.', logoKey: 'github', providerFactory: () => new firebase.auth.GithubAuthProvider() },
    { id: 'apple.com', label: 'Apple', company: 'Apple Inc.', logoKey: 'apple', providerFactory: () => new firebase.auth.OAuthProvider('apple.com') }
  ];

  let currentUser = null;
  let unsubscribeUserDoc = null;
  let initialDataLoaded = false;
  const minLoading = 500;

  function goBack(){ if (window.history.length>1) window.history.back(); else window.location.href='index.html'; }

  // Modal helpers
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalCancel = document.getElementById('modalCancel');
  const modalConfirm = document.getElementById('modalConfirm');
  let modalResolve = null;

  function showConfirm(title, message, confirmText='Unlink') {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalConfirm.textContent = confirmText;
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden', 'false');
    return new Promise((resolve) => {
      modalResolve = resolve;
    });
  }
  modalCancel.addEventListener('click', () => { closeModal(false); });
  modalConfirm.addEventListener('click', () => { closeModal(true); });
  function closeModal(choice) {
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden', 'true');
    if (modalResolve) modalResolve(choice);
    modalResolve = null;
  }

  function renderPlatforms(userDocData){
    const list = document.getElementById('platformList');
    list.innerHTML = '';
    const linked = (userDocData && userDocData.linkedProviders) ? userDocData.linkedProviders : [];

    PLATFORM_LIST.forEach(p => {
      const item = document.createElement('div');
      item.className = 'profile-item';
      item.id = 'plat-'+p.id;

      // icon container with online image
      const icon = document.createElement('div');
      icon.className = 'icon';
      const img = document.createElement('img');
      img.alt = p.label + ' logo';
      img.src = LOGO_URLS[p.logoKey] || '';
      img.loading = 'lazy';
      icon.appendChild(img);

      // add overlay tick on the icon itself when linked
      if (linked.includes(p.id)) {
        const overlay = document.createElement('div');
        overlay.className = 'overlay-tick';
        overlay.innerHTML = 'âœ“';
        overlay.setAttribute('data-linked','true');
        icon.appendChild(overlay);
      }

      item.appendChild(icon);

      const content = document.createElement('div');
      content.className = 'content';
      const title = document.createElement('h3');
      title.textContent = p.label + (p.company ? (' â€” ' + p.company) : '');
      const subtitle = document.createElement('p');
      subtitle.textContent = p.company || '';
      content.appendChild(title);
      content.appendChild(subtitle);
      item.appendChild(content);

      // right side: button (Link / Unlink). We'll still show tick overlay on icon.
      const rightWrap = document.createElement('div');
      rightWrap.style.display = 'flex';
      rightWrap.style.alignItems = 'center';
      rightWrap.style.gap = '8px';

      const btn = document.createElement('button');
      btn.className = linked.includes(p.id) ? 'btn-unlink' : 'btn-link';
      btn.textContent = linked.includes(p.id) ? 'Unlink' : 'Link';
      btn.onclick = function(e){
        e.stopPropagation();
        if (!currentUser){ alert('Please sign in first.'); return; }
        if (linked.includes(p.id)) {
          // open custom confirmation modal matching page UI
          (async () => {
            const choice = await showConfirm('Unlink ' + p.label + '?', 'Are you sure you want to unlink ' + p.label + ' from your account? You may lose some features.', 'Unlink');
            if (!choice) return;
            // Optimistic UI: remove tick & change button
            setButtonState(p.id, false);
            currentUser.unlink(p.id).then(() => {
              db.collection('users').doc(currentUser.uid).set({
                linkedProviders: firebase.firestore.FieldValue.arrayRemove(p.id),
                updatedAt: new Date().toISOString()
              }, { merge: true });
            }).catch(err => {
              console.error('Unlink failed', err);
              alert('Failed to unlink: ' + (err.message || err));
              // Re-render / restore UI in case of failure
              refreshUserDocOnce();
            });
          })();
        } else {
          linkProvider(p, btn, icon);
        }
      };
      rightWrap.appendChild(btn);

      item.appendChild(rightWrap);
      list.appendChild(item);
    });
  }

  // Set button UI immediately (optimistic)
  function setButtonState(providerId, linked){
    const item = document.getElementById('plat-'+providerId);
    if (!item) return;
    const btn = item.querySelector('button');
    const icon = item.querySelector('.icon');
    if (linked) {
      btn.className = 'btn-unlink';
      btn.textContent = 'Unlink';
      // add tick if not present
      if (!icon.querySelector('.overlay-tick')){
        const overlay = document.createElement('div');
        overlay.className = 'overlay-tick';
        overlay.innerHTML = 'âœ“';
        icon.appendChild(overlay);
      }
    } else {
      btn.className = 'btn-link';
      btn.textContent = 'Link';
      const o = icon.querySelector('.overlay-tick');
      if (o) o.remove();
    }
  }

  function linkProvider(platform, btnNode, iconNode){
    if (!currentUser){ alert('Please sign in first.'); return; }
    const provider = platform.providerFactory();
    if (platform.id === 'github.com') { provider.addScope('read:user'); provider.addScope('user:email'); }
    // call linkWithPopup triggered by user click to open provider sign-in page
    currentUser.linkWithPopup(provider).then(result => {
      // Optimistically update UI before firestore roundtrip
      setButtonState(platform.id, true);
      db.collection('users').doc(currentUser.uid).set({
        linkedProviders: firebase.firestore.FieldValue.arrayUnion(platform.id),
        updatedAt: new Date().toISOString()
      }, { merge: true }).catch(()=>{});
    }).catch(err => {
      console.error('Link failed', err);
      if (err && err.code === 'auth/credential-already-in-use') {
        alert('This ' + platform.label + ' account is already linked to another user.');
      } else if (err && err.code === 'auth/popup-closed-by-user') {
        // user closed popup â€” no action needed
      } else {
        alert('Failed to link ' + platform.label + ': ' + (err.message || err));
      }
      // restore button state from server copy (best effort)
      refreshUserDocOnce();
    });
  }

  function unlinkProvider(providerId){
    // not used anymore (kept for reference)
    if (!currentUser) return;
    if (!confirm('Unlink this provider?')) return;
    currentUser.unlink(providerId).then(() => {
      db.collection('users').doc(currentUser.uid).set({
        linkedProviders: firebase.firestore.FieldValue.arrayRemove(providerId),
        updatedAt: new Date().toISOString()
      }, { merge: true });
    }).catch(err => {
      console.error('Unlink failed', err);
      alert('Failed to unlink: ' + (err.message || err));
    });
  }

  // Refreshes user doc once from server to sync UI after an error
  function refreshUserDocOnce(){
    if (!currentUser) return;
    db.collection('users').doc(currentUser.uid).get({source:'server'}).then(doc => {
      renderPlatforms(doc.exists ? doc.data() : {});
    }).catch(()=>{});
  }

  function attachRealtimeUserDoc(uid){
    if (!uid) return;
    const ref = db.collection('users').doc(uid);
    if (unsubscribeUserDoc) { try { unsubscribeUserDoc(); } catch(e){}; unsubscribeUserDoc=null; }
    unsubscribeUserDoc = ref.onSnapshot(snap => {
      const data = snap.exists ? snap.data() : {};
      renderPlatforms(data);
      if (!initialDataLoaded) {
        initialDataLoaded = true;
        setTimeout(()=>{ document.getElementById('loadingContainer').style.display='none'; document.getElementById('mainContent').style.display='block'; }, minLoading);
      }
    }, err => {
      console.error('Realtime user doc error', err);
      renderPlatforms({});
    });
  }

  auth.onAuthStateChanged(user => {
    if (unsubscribeUserDoc) { try { unsubscribeUserDoc(); } catch(e){}; unsubscribeUserDoc=null; }
    currentUser = user || null;
    if (currentUser) {
      const uref = db.collection('users').doc(currentUser.uid);
      uref.set({ uid: currentUser.uid, displayName: currentUser.displayName || null }, { merge: true }).catch(()=>{});
      attachRealtimeUserDoc(currentUser.uid);
    } else {
      // If there's no user, go to signin page (preserve behaviour of original file)
      window.location.replace('signin.html');
    }
  });

  // placeholders (before realtime binds)
  document.addEventListener('DOMContentLoaded', function(){
    const list = document.getElementById('platformList');
    list.innerHTML = '';
    PLATFORM_LIST.forEach(p => {
      const ph = document.createElement('div');
      ph.className = 'profile-item';
      ph.innerHTML = `
        <div class="icon"><img src="${LOGO_URLS[p.logoKey]}" alt="${p.label}"></div>
        <div class="content"><h3>${p.label} â€” ${p.company}</h3><p>${p.company}</p></div>
        <div style="display:flex;align-items:center;gap:8px"><button class="btn-link">Link</button></div>
      `;
      list.appendChild(ph);
    });
  });
  </script>
</body>
</html>
