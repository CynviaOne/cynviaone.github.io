<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CynviaOne — Supported platforms</title>

<!-- Roboto + Material Symbols Rounded -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,600,1,0" rel="stylesheet">

<style>
:root{--bg:#fbf9fb;--card:#e6e4e7;--muted:#6d6c6d;--title:#0b0b0b;--accent:#3f5f90;--radius:18px;--max-w:420px;--icon-size-lg:28px;--icon-slot:56px;--gap-22:18px}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Roboto",system-ui,Arial;color:var(--title);-webkit-font-smoothing:antialiased}
.wrap{max-width:var(--max-w);margin:8px auto;padding:8px 12px 40px}
.material-rounded{font-family: 'Material Symbols Rounded';font-variation-settings: "FILL" 1, "wght" 600, "GRAD" 0, "opsz" 40;display:inline-block;line-height:1;vertical-align:middle}
.icon-md{font-size:var(--icon-size-lg)}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}.left{display:flex;align-items:center;gap:8px}
.btn-close{background:transparent;border:0;padding:0;margin:0;font-size:18px;cursor:pointer;color:var(--title);display:inline-flex;align-items:center;justify-content:center}
.logo{font-weight:700;font-size:20px;line-height:1}.logo .one{color:var(--accent);font-weight:600}
.actions{display:flex;gap:12px;align-items:center}.action-icon{background:transparent;border:0;padding:6px;font-size:24px;cursor:pointer;color:var(--title)}

/* page header */
.page-header{padding:16px 2px 20px}.page-header h1{margin:0 0 8px;font-size:36px;font-weight:700;line-height:1.05}
.page-header .subtitle{margin:0 0 12px;font-size:16px;font-weight:600;color:var(--title)}
.page-header .description{margin:0;font-size:14px;line-height:1.4;color:var(--title);opacity:0.85;font-weight:400}

/* card list */
.profile-section{background:var(--card);border-radius:var(--radius);padding:6px;margin-bottom:var(--gap-22)}
.profile-item{display:flex;align-items:center;gap:14px;padding:14px;cursor:default;transition:all 0.15s ease;position:relative}
.profile-item + .profile-item::before{content:"";display:block;position:absolute;left:0;right:0;height:2px;top:0;background:var(--bg)}
.icon{width:var(--icon-slot);height:var(--icon-slot);display:flex;align-items:center;justify-content:center;flex-shrink:0;border-radius:12px;background:#fff;box-shadow:0 0 0 1px rgba(0,0,0,0.03);position:relative;overflow:visible}
.icon img{max-width:36px;max-height:36px;display:block}
.icon .overlay-tick{position:absolute;right:-6px;bottom:-6px;background:#12c76a;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.12)}

/* Ensure simple rows don't inherit white box */
.simple-row{display:flex;align-items:center;gap:12px;padding:14px;border-radius:12px;background:transparent;margin-top:8px}
.simple-row .simple-icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:transparent;box-shadow:none}
.simple-row .simple-icon .material-rounded{font-size:22px;color:var(--title)}

.profile-item .content{flex:1;min-width:0}
.profile-item h3{margin:0 0 3px;font-size:16px;font-weight:700}
.profile-item p{margin:0;font-size:13px;color:var(--muted);font-weight:500}
.btn-link{padding:8px 16px;border-radius:999px;border:none;font-size:14px;font-weight:700;cursor:pointer;transition:all .12s ease;background:#000;color:#fff}
.btn-unlink{padding:8px 14px;border-radius:999px;border:1px solid rgba(0,0,0,0.08);font-size:14px;font-weight:700;cursor:pointer;transition:all .12s ease;background:transparent;color:var(--title)}

/* looking else */
.more{font-size:14px;font-weight:700;margin-top:8px;margin-bottom:10px;padding-left:2px}

/* loading */
.loading-container {display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;margin:12px 0}
.spinner {width:34px;height:34px;border:4px solid transparent;border-top:4px solid #000;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* responsive */
@media (max-width:420px){:root{--max-w:100%}.wrap{padding-left:10px;padding-right:10px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <button class="btn-close" aria-label="Go back" onclick="goBack()">
          <span class="material-rounded icon-md">arrow_back</span>
        </button>
        <div class="logo">Cynvia<span class="one">One</span></div>
      </div>
      <div class="actions">
        <!-- help icon not in white box -->
        <button class="action-icon" title="Help" aria-label="Help" onclick="window.location.href='mailto:support.cynviaone@outlook.com'">
          <span class="material-rounded icon-md">help</span>
        </button>
      </div>
    </div>

    <div class="page-header">
      <h1>Supported platforms</h1>
      <p class="subtitle">Manage and connect your account with third-party services.</p>
      <p class="description">Linking supported platforms allows you to sign in faster, sync data, and enhance your experience across different apps and services.</p>
    </div>

    <!-- Loading -->
    <div id="loadingContainer" class="loading-container" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
    </div>

    <!-- Main -->
    <div id="mainContent" style="display:none;">
      <div class="profile-section" id="platformList">
        <!-- platform items injected by JS -->
      </div>

      <div class="more">looking for something else?</div>

      <!-- About / Send feedback as simple rows (no white icon box, and NO grey card behind them) -->
      <div class="simple-row" onclick="window.location.href='about.html'" role="button" style="cursor:pointer">
        <div class="simple-icon"><span class="material-rounded">info</span></div>
        <div style="flex:1"><h3>About CynviaOne</h3><p>Learn more about CynviaOne</p></div>
      </div>

      <div class="simple-row" onclick="window.location.href='mailto:support.cynviaone@outlook.com?subject=Feedback'" role="button" style="cursor:pointer">
        <div class="simple-icon"><span class="material-rounded">feedback</span></div>
        <div style="flex:1"><h3>Send feedback</h3><p>Share your thoughts with us</p></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // Firebase config (same as your uploaded file)
  const firebaseConfig = {
    apiKey: "AIzaSyDaRo6aKcg5Tju7spWUtLKOUBEItUpgF90",
    authDomain: "ouruiofficial.firebaseapp.com",
    projectId: "ouruiofficial",
    storageBucket: "ouruiofficial.firebasestorage.app",
    messagingSenderId: "513335403025",
    appId: "1:513335403025:web:b965e1187d5386d52d87b0",
    measurementId: "G-X5QWNP8DMK"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Use online logos (Wikimedia). These will load from web when the page runs.
  const LOGO_URLS = {
    google: 'https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg',
    microsoft: 'https://upload.wikimedia.org/wikipedia/commons/9/96/Microsoft_logo_%282012%29.svg',
    github: 'https://upload.wikimedia.org/wikipedia/commons/9/91/Octicons-mark-github.svg',
    apple: 'https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg'
  };

  const PLATFORM_LIST = [
    { id: 'google.com', label: 'Google', company: 'Google LLC', logoKey: 'google', providerFactory: () => new firebase.auth.GoogleAuthProvider() },
    { id: 'microsoft.com', label: 'Microsoft', company: 'Microsoft Corporation', logoKey: 'microsoft', providerFactory: () => new firebase.auth.OAuthProvider('microsoft.com') },
    { id: 'github.com', label: 'GitHub', company: 'GitHub, Inc.', logoKey: 'github', providerFactory: () => new firebase.auth.GithubAuthProvider() },
    { id: 'apple.com', label: 'Apple', company: 'Apple Inc.', logoKey: 'apple', providerFactory: () => new firebase.auth.OAuthProvider('apple.com') }
  ];

  let currentUser = null;
  let unsubscribeUserDoc = null;
  let initialDataLoaded = false;
  const minLoading = 350;

  function goBack(){ if (window.history.length>1) window.history.back(); else window.location.href='index.html'; }

  // Helper to immediately toggle UI for a provider (optimistic)
  function toggleProviderUI(providerId, linked){
    const item = document.getElementById('plat-'+providerId);
    if (!item) return;
    const icon = item.querySelector('.icon');
    const existingTick = icon && icon.querySelector('.overlay-tick');
    const btn = item.querySelector('button');
    if (linked){
      if (!existingTick){
        const overlay = document.createElement('div');
        overlay.className = 'overlay-tick';
        overlay.innerHTML = '✓';
        icon.appendChild(overlay);
      }
      if (btn){
        btn.className = 'btn-unlink';
        btn.textContent = 'Unlink';
      }
    } else {
      if (existingTick) existingTick.remove();
      if (btn){
        btn.className = 'btn-link';
        btn.textContent = 'Link';
      }
    }
  }

  function renderPlatforms(userDocData){
    const list = document.getElementById('platformList');
    list.innerHTML = '';
    const linked = (userDocData && userDocData.linkedProviders) ? userDocData.linkedProviders : [];

    PLATFORM_LIST.forEach(p => {
      const item = document.createElement('div');
      item.className = 'profile-item';
      item.id = 'plat-'+p.id;

      // icon container with online image
      const icon = document.createElement('div');
      icon.className = 'icon';
      const img = document.createElement('img');
      img.alt = p.label + ' logo';
      img.src = LOGO_URLS[p.logoKey] || '';
      img.loading = 'lazy';
      icon.appendChild(img);

      // add overlay tick on the icon itself when linked
      if (linked.includes(p.id)) {
        const overlay = document.createElement('div');
        overlay.className = 'overlay-tick';
        overlay.innerHTML = '✓';
        icon.appendChild(overlay);
      }

      item.appendChild(icon);

      const content = document.createElement('div');
      content.className = 'content';
      const title = document.createElement('h3');
      title.textContent = p.label + (p.company ? (' — ' + p.company) : '');
      const subtitle = document.createElement('p');
      subtitle.textContent = p.company || '';
      content.appendChild(title);
      content.appendChild(subtitle);
      item.appendChild(content);

      // right side: button (Link / Unlink).
      const rightWrap = document.createElement('div');
      rightWrap.style.display = 'flex';
      rightWrap.style.alignItems = 'center';
      rightWrap.style.gap = '8px';

      const btn = document.createElement('button');
      btn.className = linked.includes(p.id) ? 'btn-unlink' : 'btn-link';
      btn.textContent = linked.includes(p.id) ? 'Unlink' : 'Link';
      btn.onclick = function(e){
        e.stopPropagation();
        if (!currentUser){ alert('Please sign in first.'); return; }
        if (linked.includes(p.id)) {
          // unlink optimistically in UI; actual changes happen in promise
          toggleProviderUI(p.id, false);
          unlinkProvider(p.id);
        } else {
          // open popup and link; show loading state on button
          btn.disabled = true;
          btn.textContent = 'Connecting...';
          linkProvider(p).finally(()=>{ btn.disabled = false; });
        }
      };
      rightWrap.appendChild(btn);

      item.appendChild(rightWrap);
      list.appendChild(item);
    });
  }

  // link provider (returns Promise)
  function linkProvider(platform){
    if (!currentUser){ return Promise.reject(new Error('Not signed in')); }
    const provider = platform.providerFactory();
    if (platform.id === 'github.com') { provider.addScope('read:user'); provider.addScope('user:email'); }
    return currentUser.linkWithPopup(provider).then(result => {
      // update Firestore
      return db.collection('users').doc(currentUser.uid).set({
        linkedProviders: firebase.firestore.FieldValue.arrayUnion(platform.id),
        updatedAt: new Date().toISOString()
      }, { merge: true }).then(()=>{
        // immediate UI update
        toggleProviderUI(platform.id, true);
      });
    }).catch(err => {
      console.error('Link failed', err);
      // revert UI if needed
      toggleProviderUI(platform.id, false);
      if (err && err.code === 'auth/credential-already-in-use') {
        alert('This ' + platform.label + ' account is already linked to another user.');
      } else if (err && err.code === 'auth/account-exists-with-different-credential') {
        alert('Account exists with different credential. Please sign in using that provider first.');
      } else {
        alert('Failed to link ' + platform.label + ': ' + (err.message || err));
      }
      throw err;
    });
  }

  function unlinkProvider(providerId){
    if (!currentUser) return;
    // perform unlink, then update Firestore and UI
    return currentUser.unlink(providerId).then(() => {
      return db.collection('users').doc(currentUser.uid).set({
        linkedProviders: firebase.firestore.FieldValue.arrayRemove(providerId),
        updatedAt: new Date().toISOString()
      }, { merge: true }).then(()=>{
        toggleProviderUI(providerId, false);
      });
    }).catch(err => {
      console.error('Unlink failed', err);
      alert('Failed to unlink: ' + (err.message || err));
      // try to refresh UI from server state
      return Promise.resolve();
    });
  }

  function attachRealtimeUserDoc(uid){
    if (!uid) return;
    const ref = db.collection('users').doc(uid);
    if (unsubscribeUserDoc) { try { unsubscribeUserDoc(); } catch(e){}; unsubscribeUserDoc=null; }
    unsubscribeUserDoc = ref.onSnapshot(snap => {
      const data = snap.exists ? snap.data() : {};
      renderPlatforms(data);
      if (!initialDataLoaded) {
        initialDataLoaded = true;
        setTimeout(()=>{ document.getElementById('loadingContainer').style.display='none'; document.getElementById('mainContent').style.display='block'; }, minLoading);
      }
    }, err => {
      console.error('Realtime user doc error', err);
      renderPlatforms({});
    });
  }

  auth.onAuthStateChanged(user => {
    if (unsubscribeUserDoc) { try { unsubscribeUserDoc(); } catch(e){}; unsubscribeUserDoc=null; }
    currentUser = user || null;
    if (currentUser) {
      const uref = db.collection('users').doc(currentUser.uid);
      uref.set({ uid: currentUser.uid, displayName: currentUser.displayName || null }, { merge: true }).catch(()=>{});
      attachRealtimeUserDoc(currentUser.uid);
    } else {
      window.location.replace('signin.html');
    }
  });

  // placeholders
  document.addEventListener('DOMContentLoaded', function(){
    const list = document.getElementById('platformList');
    list.innerHTML = '';
    PLATFORM_LIST.forEach(p => {
      const ph = document.createElement('div');
      ph.className = 'profile-item';
      ph.innerHTML = `
        <div class="icon"><img src="${LOGO_URLS[p.logoKey]}" alt="${p.label}"></div>
        <div class="content"><h3>${p.label} — ${p.company}</h3><p>${p.company}</p></div>
        <div style="display:flex;align-items:center;gap:8px"><button class="btn-link">Link</button></div>
      `;
      list.appendChild(ph);
    });
  });
  </script>
</body>
</html>
