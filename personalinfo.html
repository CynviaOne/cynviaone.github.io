<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CynviaOne â€” Personal Info</title>

<!-- Roboto -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<!-- Material Symbols Rounded (filled) -->
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,600,1,0" rel="stylesheet">

<style>
  :root{
    --bg:#fbf9fb;
    --card:#e6e4e7;
    --muted:#a7a5a6;
    --title:#0b0b0b;
    --accent:#3f5f90;
    --radius:18px;
    --max-w:380px;
    --icon-size-lg:32px;
    --icon-size-md:24px;
    --icon-slot:44px;
    --gap-22:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:"Roboto",system-ui,Arial;color:var(--title);-webkit-font-smoothing:antialiased}
  .wrap{max-width:var(--max-w);margin:8px auto;padding:8px 12px 40px}

  /* Material filled (rounded) */
  .material-rounded{
    font-family: 'Material Symbols Rounded';
    font-variation-settings: "FILL" 1, "wght" 600, "GRAD" 0, "opsz" 40;
    display:inline-block;
    line-height:1;
    vertical-align:middle;
  }

  .icon-sm{font-size:14px}
  .icon-md{font-size:var(--icon-size-md)}
  .icon-lg{font-size:var(--icon-size-lg)}

  /* TOP BAR */
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .left{display:flex;align-items:center;gap:8px}
  .btn-close{
    background:transparent;border:0;padding:0;margin:0;font-size:18px;cursor:pointer;color:var(--title);
    display:inline-flex;align-items:center;justify-content:center;
  }
  .btn-close:focus{outline:2px solid rgba(0,0,0,0.08);outline-offset:2px;border-radius:6px}
  .logo{font-weight:700;font-size:20px;line-height:1}
  .logo .one{color:var(--accent);font-weight:600}
  .actions{display:flex;gap:12px;align-items:center}
  .action-icon{background:transparent;border:0;padding:6px;font-size:24px;cursor:pointer;color:var(--title)}
  .action-icon:focus{outline:2px solid rgba(0,0,0,0.06);outline-offset:2px;border-radius:6px}

  /* PAGE HEADER */
  .page-header{padding:16px 2px 20px}
  .page-header h1{margin:0 0 8px;font-size:32px;font-weight:700;line-height:1.1}
  .page-header .subtitle{margin:0 0 12px;font-size:16px;font-weight:600;color:var(--title)}
  .page-header .description{margin:0;font-size:14px;line-height:1.4;color:var(--title);opacity:0.8;font-weight:400}

  /* PROFILE SECTION */
  .profile-section{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:var(--gap-22)}
  
  .profile-item{display:flex;align-items:center;gap:14px;padding:12px 0}
  .profile-item:first-child{padding-top:0}
  .profile-item:last-child{padding-bottom:0}
  .profile-item + .profile-item{border-top:1px solid rgba(0,0,0,0.06)}

  .profile-item .icon{
    width:var(--icon-slot);
    height:var(--icon-slot);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
  }

  .profile-item .content{flex:1}
  .profile-item h3{margin:0 0 3px;font-size:16px;font-weight:600;color:var(--title)}
  .profile-item p{margin:0;font-size:13px;font-weight:400;color:var(--muted);line-height:1.3}

  .profile-item .right{display:flex;align-items:center;gap:8px;flex-shrink:0}

  /* Avatar display */
  .avatar-display{
    width:40px;
    height:40px;
    border-radius:50%;
    background:var(--accent);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-size:18px;
    font-weight:700;
  }

  /* Bottom text */
  .more{font-size:18px;font-weight:600;margin-top:4px;padding-left:2px}

  /* icon sizing tweaks */
  .material-rounded.icon-lg{line-height:1;width:var(--icon-size-lg);height:var(--icon-size-lg);display:block;text-align:center;font-size:var(--icon-size-lg)}
  .material-rounded.icon-md{line-height:1;width:var(--icon-size-md);height:var(--icon-size-md);display:block;text-align:center;font-size:var(--icon-size-md)}

  /* Search bar styles */
  .search-container{
    position:relative;
    margin-bottom:20px;
    display:none;
  }
  .search-container.active{
    display:block;
  }
  .search-bar{
    width:100%;
    background:var(--card);
    border:1px solid rgba(0,0,0,0.1);
    border-radius:var(--radius);
    padding:12px 16px;
    font-size:16px;
    font-family:"Roboto",system-ui,Arial;
    outline:none;
  }
  .search-bar:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(63,95,144,0.1);
  }

  /* Interactive states */
  .profile-item{cursor:pointer}

  @media (max-width:420px){
    :root{--max-w:100%}
    .wrap{padding-left:10px;padding-right:10px}
  }
</style>
</head>
<body>
  <!-- SEARCH BAR (overlay at top) -->
  <div id="searchContainer" class="search-container">
    <input type="text" id="searchBar" class="search-bar" placeholder="Search CynviaOne account settings...">
  </div>

  <div class="wrap">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="left">
        <!-- Close button triggers history.back() -->
        <button class="btn-close" aria-label="Close / Go back" onclick="goBack()">
          <span class="material-rounded icon-md">close</span>
        </button>
        <!-- single-word logo with only "One" colored -->
        <div class="logo">Cynvia<span class="one">One</span></div>
      </div>

      <div class="actions" aria-hidden="true">
        <!-- help (bigger, no circle) -->
        <button class="action-icon" title="Help" aria-label="Help" onclick="window.location.href='mailto:support.cynviaone@outlook.com'">
          <span class="material-rounded icon-md">help</span>
        </button>
      </div>
    </div>

    <!-- PAGE HEADER -->
    <div class="page-header">
      <h1>Personal info</h1>
      <p class="subtitle">Your CynviaOne profile information</p>
      <p class="description">Manage and update your basic details such as your name, profile photo, gender, date of birth etc. Keeping your information up to date helps us personalize your experience and keep your account secure.</p>
    </div>

    <!-- PROFILE SECTION -->
    <div class="profile-section">
      <!-- Profile Picture -->
      <div class="profile-item" id="profilePictureItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-lg">photo_camera</span>
        </div>
        <div class="content">
          <h3>Profile picture</h3>
          <p>Add your profile picture</p>
        </div>
        <div class="right">
          <div id="userAvatar" class="avatar-display">U</div>
        </div>
      </div>

      <!-- Name -->
      <div class="profile-item" id="nameItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-lg">badge</span>
        </div>
        <div class="content">
          <h3>Name</h3>
          <p id="userName">(User name show here)</p>
        </div>
      </div>

      <!-- Gender -->
      <div class="profile-item" id="genderItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-lg">person</span>
        </div>
        <div class="content">
          <h3>Gender</h3>
          <p id="userGender">(User gender show here)</p>
        </div>
      </div>

      <!-- Country -->
      <div class="profile-item" id="countryItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-lg">public</span>
        </div>
        <div class="content">
          <h3>Country</h3>
          <p id="userCountry">(User country show here)</p>
        </div>
      </div>
    </div>

    <div class="more">Looking for something else?</div>

    <!-- ADDITIONAL OPTIONS -->
    <div class="profile-section">
      <!-- About CynviaOne -->
      <div class="profile-item" id="aboutItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-sm">info</span>
        </div>
        <div class="content">
          <h3>About CynviaOne</h3>
          <p>Learn more about CynviaOne</p>
        </div>
      </div>

      <!-- Send feedback -->
      <div class="profile-item" id="feedbackItem" tabindex="0" role="button">
        <div class="icon">
          <span class="material-rounded icon-sm">feedback</span>
        </div>
        <div class="content">
          <h3>Send feedback</h3>
          <p>Share your thoughts with us</p>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <!-- Photo Upload Modal -->
    <div id="photoModal" class="modal-overlay">
      <div class="modal">
        <h3>Profile Picture</h3>
        <div class="photo-upload">
          <div class="upload-area" id="uploadArea">
            <span class="material-rounded icon-lg" style="display:block;margin-bottom:8px;color:var(--muted)">photo_camera</span>
            <p style="margin:0;color:var(--muted);font-size:14px;">Click to upload or drag and drop</p>
          </div>
          <input type="file" id="fileInput" class="file-input" accept="image/*">
          
          <div id="previewContainer" class="preview-container">
            <img id="previewImage" class="preview-image">
          </div>
          
          <div id="cropContainer" class="crop-container">
            <canvas id="cropCanvas" style="max-width:100%;max-height:100%;"></canvas>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn secondary" onclick="closeModal('photoModal')">Cancel</button>
          <button class="modal-btn primary" id="savePhotoBtn" onclick="saveProfilePhoto()">Save</button>
        </div>
      </div>
    </div>

    <!-- Name Edit Modal -->
    <div id="nameModal" class="modal-overlay">
      <div class="modal">
        <h3>Edit Name</h3>
        <input type="text" id="firstNameInput" class="modal-input" placeholder="First name">
        <input type="text" id="lastNameInput" class="modal-input" placeholder="Last name">
        <div class="modal-buttons">
          <button class="modal-btn secondary" onclick="closeModal('nameModal')">Cancel</button>
          <button class="modal-btn primary" onclick="saveName()">Save</button>
        </div>
      </div>
    </div>

    <!-- Gender Edit Modal -->
    <div id="genderModal" class="modal-overlay">
      <div class="modal">
        <h3>Select Gender</h3>
        <select id="genderSelect" class="modal-select">
          <option value="">Select gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
          <option value="Prefer not to say">Prefer not to say</option>
        </select>
        <div class="modal-buttons">
          <button class="modal-btn secondary" onclick="closeModal('genderModal')">Cancel</button>
          <button class="modal-btn primary" onclick="saveGender()">Save</button>
        </div>
      </div>
    </div>

    <!-- Country Edit Modal -->
    <div id="countryModal" class="modal-overlay">
      <div class="modal">
        <h3>Select Country</h3>
        <select id="countrySelect" class="modal-select">
          <option value="">Select country</option>
          <option value="United States">United States</option>
          <option value="Canada">Canada</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="Australia">Australia</option>
          <option value="Germany">Germany</option>
          <option value="France">France</option>
          <option value="Japan">Japan</option>
          <option value="India">India</option>
          <option value="Brazil">Brazil</option>
          <option value="Mexico">Mexico</option>
          <option value="Other">Other</option>
        </select>
        <div class="modal-buttons">
          <button class="modal-btn secondary" onclick="closeModal('countryModal')">Cancel</button>
          <button class="modal-btn primary" onclick="saveCountry()">Save</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    function goBack(){
      if (window.history.length > 1) {
        window.history.back();
      } else {
        console.log('No history to go back to.');
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Photo upload and crop functionality
    let currentImageFile = null;
    let cropCanvas = null;
    let cropContext = null;

    function initPhotoUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const previewContainer = document.getElementById('previewContainer');
      const previewImage = document.getElementById('previewImage');
      const cropContainer = document.getElementById('cropContainer');
      const canvas = document.getElementById('cropCanvas');
      
      cropCanvas = canvas;
      cropContext = canvas.getContext('2d');

      // Click to upload
      uploadArea.addEventListener('click', () => fileInput.click());

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });
    }

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      currentImageFile = file;
      const reader = new FileReader();
      
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          setupCropCanvas(img);
          document.getElementById('previewContainer').style.display = 'none';
          document.getElementById('cropContainer').style.display = 'block';
        };
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    }

    function setupCropCanvas(img) {
      const container = document.getElementById('cropContainer');
      const canvas = cropCanvas;
      
      // Set canvas size to container
      const containerRect = container.getBoundingClientRect();
      canvas.width = containerRect.width;
      canvas.height = containerRect.height;
      
      // Calculate scaling to fit image in canvas
      const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      
      // Center the image
      const x = (canvas.width - scaledWidth) / 2;
      const y = (canvas.height - scaledHeight) / 2;
      
      // Clear and draw
      cropContext.fillStyle = '#000';
      cropContext.fillRect(0, 0, canvas.width, canvas.height);
      cropContext.drawImage(img, x, y, scaledWidth, scaledHeight);
      
      // Draw crop circle overlay
      drawCropOverlay();
    }

    function drawCropOverlay() {
      const canvas = cropCanvas;
      const ctx = cropContext;
      
      // Save current state
      ctx.save();
      
      // Draw semi-transparent overlay
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Create circular crop area
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(canvas.width, canvas.height) / 3;
      
      // Clear circle area
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.fill();
      
      // Draw circle border
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
      ctx.stroke();
      
      ctx.restore();
    }

    function saveProfilePhoto() {
      if (!currentImageFile) return;
      
      // Create cropped image
      const canvas = cropCanvas;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(canvas.width, canvas.height) / 3;
      
      // Create new canvas for final crop
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = radius * 2;
      finalCanvas.height = radius * 2;
      const finalCtx = finalCanvas.getContext('2d');
      
      // Copy cropped circular area
      finalCtx.beginPath();
      finalCtx.arc(radius, radius, radius, 0, Math.PI * 2);
      finalCtx.clip();
      
      finalCtx.drawImage(canvas, centerX - radius, centerY - radius, radius * 2, radius * 2, 0, 0, radius * 2, radius * 2);
      
      // Convert to blob and update avatar
      finalCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const avatar = document.getElementById('userAvatar');
        avatar.style.backgroundImage = `url(${url})`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
        
        // Save to localStorage
        try {
          const reader = new FileReader();
          reader.onload = () => {
            localStorage.setItem('ourui_profilePicture', reader.result);
          };
          reader.readAsDataURL(blob);
        } catch (e) {
          console.log('Error saving photo:', e);
        }
        
        closeModal('photoModal');
      }, 'image/jpeg', 0.8);
    }

    // Save functions
    function saveName() {
      const firstName = document.getElementById('firstNameInput').value.trim();
      const lastName = document.getElementById('lastNameInput').value.trim();
      const fullName = `${firstName} ${lastName}`.trim();
      
      if (fullName) {
        document.getElementById('userName').textContent = fullName;
        document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
        
        try {
          localStorage.setItem('ourui_displayName', fullName);
          localStorage.setItem('ourui_avatarInitial', firstName.charAt(0).toUpperCase());
        } catch (e) {
          console.log('Error saving name:', e);
        }
      }
      
      closeModal('nameModal');
    }

    function saveGender() {
      const gender = document.getElementById('genderSelect').value;
      if (gender) {
        document.getElementById('userGender').textContent = gender;
        try {
          localStorage.setItem('ourui_gender', gender);
        } catch (e) {
          console.log('Error saving gender:', e);
        }
      }
      closeModal('genderModal');
    }

    function saveCountry() {
      const country = document.getElementById('countrySelect').value;
      if (country) {
        document.getElementById('userCountry').textContent = country;
        try {
          localStorage.setItem('ourui_country', country);
        } catch (e) {
          console.log('Error saving country:', e);
        }
      }
      closeModal('countryModal');
    }

    // Add click handlers for interactive items
    const profileItems = document.querySelectorAll('.profile-item');
    const searchContainer = document.getElementById('searchContainer');
    const searchBar = document.getElementById('searchBar');
    
    profileItems.forEach(item => {
      // Click handler
      item.addEventListener('click', () => {
        const itemId = item.id;
        console.log(`Clicked on: ${itemId}`);
        
        // You can add specific actions for each item here
        switch(itemId) {
          case 'profilePictureItem':
            console.log('Profile picture clicked - opening photo editor');
            openModal('photoModal');
            break;
          case 'nameItem':
            console.log('Name clicked - opening name editor');
            // Pre-fill current name
            const currentName = document.getElementById('userName').textContent;
            if (currentName && currentName !== '(User name show here)') {
              const nameParts = currentName.split(' ');
              document.getElementById('firstNameInput').value = nameParts[0] || '';
              document.getElementById('lastNameInput').value = nameParts.slice(1).join(' ') || '';
            }
            openModal('nameModal');
            break;
          case 'genderItem':
            console.log('Gender clicked - opening gender selector');
            openModal('genderModal');
            break;
          case 'countryItem':
            console.log('Country clicked - opening country selector');
            openModal('countryModal');
            break;
          case 'aboutItem':
            console.log('About CynviaOne clicked');
            break;
          case 'feedbackItem':
            console.log('Send feedback clicked');
            break;
        }
      });

      // Keyboard accessibility
      item.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click();
        }
      });
    });

    // Search bar escape key to hide
    searchBar.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        searchContainer.classList.remove('active');
      }
    });

    // Search functionality with keyword filtering
    const searchableItems = [
      { keywords: ['profile', 'picture', 'photo', 'avatar', 'image'], element: 'profilePictureItem' },
      { keywords: ['name', 'username', 'display', 'first', 'last'], element: 'nameItem' },
      { keywords: ['gender', 'sex', 'male', 'female'], element: 'genderItem' },
      { keywords: ['country', 'location', 'region', 'place'], element: 'countryItem' },
      { keywords: ['about', 'info', 'information', 'cynviaone'], element: 'aboutItem' },
      { keywords: ['feedback', 'report', 'suggest', 'comment'], element: 'feedbackItem' }
    ];

    searchBar.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      
      if (query === '') {
        // Show all items when search is empty
        profileItems.forEach(item => {
          item.style.display = 'flex';
        });
        return;
      }

      // Filter items based on keywords
      profileItems.forEach(item => {
        const searchItem = searchableItems.find(s => s.element === item.id);
        if (searchItem) {
          const matches = searchItem.keywords.some(keyword => 
            keyword.includes(query) || query.includes(keyword)
          );
          item.style.display = matches ? 'flex' : 'none';
        }
      });
    });

    // Load user data (frontend simulation)
    function loadUserData() {
      // Simulate loading user data from localStorage or default values
      try {
        const cachedName = localStorage.getItem('ourui_displayName') || 'User Name';
        const cachedInitial = localStorage.getItem('ourui_avatarInitial') || 'U';
        const cachedGender = localStorage.getItem('ourui_gender') || 'Not specified';
        const cachedCountry = localStorage.getItem('ourui_country') || 'Not specified';

        document.getElementById('userName').textContent = cachedName;
        document.getElementById('userAvatar').textContent = cachedInitial.toUpperCase();
        document.getElementById('userGender').textContent = cachedGender;
        document.getElementById('userCountry').textContent = cachedCountry;
      } catch (e) {
        console.log('Error loading cached data:', e);
      }
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadUserData();
      initPhotoUpload();
      
      // Load saved profile picture
      try {
        const savedPicture = localStorage.getItem('ourui_profilePicture');
        if (savedPicture) {
          const avatar = document.getElementById('userAvatar');
          avatar.style.backgroundImage = `url(${savedPicture})`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        }
      } catch (e) {
        console.log('Error loading saved picture:', e);
      }
      
      // Close modals when clicking outside
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });
    });
  </script>

  <!-- Firebase logic for loading user data (same as account.html) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDaRo6aKcg5Tju7spWUtLKOUBEItUpgF90",
      authDomain: "ouruiofficial.firebaseapp.com",
      projectId: "ouruiofficial",
      storageBucket: "ouruiofficial.firebasestorage.app",
      messagingSenderId: "513335403025",
      appId: "1:513335403025:web:b965e1187d5386d52d87b0",
      measurementId: "G-X5QWNP8DMK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const userGenderEl = document.getElementById('userGender');
    const userCountryEl = document.getElementById('userCountry');

    function updateUserInfo(name, initial, gender, country) {
      if (name) userNameEl.textContent = name;
      if (initial) userAvatarEl.textContent = initial.toUpperCase();
      if (gender) userGenderEl.textContent = gender;
      if (country) userCountryEl.textContent = country;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // not signed in -> redirect to signin
        window.location.href = 'signin.html';
        return;
      }

      // immediate fallback from Auth (fast)
      let fastName = user.displayName || '';
      if (!fastName && user.email) {
        const local = user.email.split('@')[0].replace(/[._]/g, ' ');
        fastName = local.charAt(0).toUpperCase() + local.slice(1);
      }
      const fastInitial = (fastName && fastName.length ? fastName.charAt(0) : (user.email ? user.email.charAt(0) : 'U'));
      updateUserInfo(fastName, fastInitial, null, null);

      // then try Firestore for canonical data
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          const data = snap.data();
          const f = (data.firstName || '').trim();
          const l = (data.lastName || '').trim();
          const full = `${f} ${l}`.trim();
          const finalName = full || user.displayName || fastName;
          const initial = (f ? f.charAt(0) : (finalName ? finalName.charAt(0) : (user.email ? user.email.charAt(0) : 'U'))).toUpperCase();
          const gender = data.gender || '(User gender show here)';
          const country = data.country || '(User country show here)';

          updateUserInfo(finalName, initial, gender, country);

          // cache for next load
          try {
            if (finalName) localStorage.setItem('ourui_displayName', finalName);
            if (initial) localStorage.setItem('ourui_avatarInitial', initial);
            if (data.gender) localStorage.setItem('ourui_gender', data.gender);
            if (data.country) localStorage.setItem('ourui_country', data.country);
          } catch (e) { /* ignore storage errors */ }
        }
      } catch (err) {
        console.error('Failed to load profile:', err);
      }
    });
  </script>
</body>
</html>
