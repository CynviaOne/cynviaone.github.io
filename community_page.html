<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CynviaOne — Community (Pixel-style)</title>

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#F5F6F7;
      --card:#ffffff;
      --muted:#9aa0a6;
      --accent:#2f5d9a; /* blue used in mock */
      --pill:#e6e7ea;
      --team-bg:#e6e7ea;
      --black:#0a0a0a;
      --rounded:18px;
      font-family: 'Quicksand', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--black)}
    .container{max-width:420px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;gap:18px;padding:18px 16px 100px}
    /* Top bar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:6px 4px}
    .brand{font-weight:700;color:var(--accent);font-size:20px}
    .account-btn{width:40px;height:40px;border-radius:50%;background:#2f5d9a;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer}
    /* Hero Title */
    .hero{padding:8px 4px}
    .hero h1{margin:8px 0;font-size:28px}
    .hero .subtitle{color:var(--muted);margin-bottom:10px}
    .help-line{display:flex;gap:8px;align-items:center;color:var(--muted);cursor:pointer}
    .help-line .material-icons{font-size:18px}

    /* Post box */
    .postbox{display:flex;align-items:center;padding:14px;border-radius:999px;background:var(--pill);gap:12px}
    .postbox .prompt{flex:1;color:var(--muted);padding-left:6px}
    .btn-post{background:var(--black);color:white;padding:8px 16px;border-radius:999px;border:none;cursor:pointer}
    /* Card styles */
    .card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 0 0 rgba(0,0,0,0)}
    .meta{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .avatar{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .meta .name{font-weight:700}
    .meta .date{color:var(--muted);font-size:13px}
    .post-text{font-weight:700;font-size:18px;margin:8px 0 12px}
    .actions{display:flex;gap:10px;align-items:center}
    .action-pill{padding:8px 12px;border-radius:16px;background:var(--pill);display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .action-pill.liked{background:black;color:white}
    .info-banner{background:var(--pill);padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center;color:var(--muted)}

    /* Replies section */
    h2.replies{font-size:30px;margin:8px 4px}
    .reply{padding:14px 4px;border-radius:6px}
    .reply .reply-card{padding:18px;border-radius:18px;background:var(--card)}
    .team-reply .reply-card{background:var(--team-bg)}
    .verified{width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:black;color:white;margin-left:8px;font-size:14px}

    /* bottom nav */
    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;width:100%;max-width:420px;padding:10px;background:transparent;display:flex;justify-content:center}
    .nav-inner{background:#d6e0f2;padding:12px;border-radius:18px;display:flex;justify-content:space-around;width:100%}
    .nav-item{display:flex;flex-direction:column;align-items:center;gap:6px;color:#223;cursor:pointer;padding:6px 12px;border-radius:12px}
    .nav-item.active{background:var(--accent);color:white}

    /* popup */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:40}
    .modal{background:white;padding:18px;border-radius:12px;max-width:420px;width:calc(100% - 32px)}
    .modal textarea{width:100%;min-height:120px;padding:8px;border-radius:8px;border:1px solid #ddd;resize:vertical}

    /* small screens tweak */
    @media (max-width:420px){
      .container{padding:14px 10px 120px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">Cynvia<span style="color:#223">One</span></div>
      <div id="accountBtn" class="account-btn" title="Open account"></div>
    </div>

    <!-- Hero -->
    <div class="hero">
      <h1>Hi, <span id="displayName">Displayname</span></h1>
      <div class="subtitle">Here you can ask your any question or communicate with community</div>
      <div id="helpLine" class="help-line"><span class="material-icons">help_outline</span><span style="text-decoration:underline">click here to know more.</span></div>
    </div>

    <!-- Post box -->
    <div class="postbox">
      <div id="postPrompt" class="prompt">how we can help you today?</div>
      <button id="postBtn" class="btn-post">Post</button>
    </div>

    <!-- Placeholder for posts -->
    <div id="postsContainer"></div>

    <!-- Info bar -->
    <div class="info-banner"><span class="material-icons">info</span><div>Community-submitted content may not be verified or up-to-date.</div></div>

    <!-- Replies header -->
    <h2 class="replies">All replies</h2>

    <!-- Replies list -->
    <div id="repliesContainer"></div>

  </div>

  <!-- bottom nav -->
  <div class="bottom-nav">
    <div class="nav-inner">
      <div class="nav-item active" id="navFeedback"><span class="material-icons">post_add</span><div>Your feedback</div></div>
      <div class="nav-item" id="navCommunity"><span class="material-icons">people</span><div>Community</div></div>
    </div>
  </div>

  <!-- modals -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Firebase (compat for simpler code) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // === FIREBASE CONFIG - user provided ===
    const firebaseConfig = {
      apiKey: "AIzaSyDaRo6aKcg5Tju7spWUtLKOUBEItUpgF90",
      authDomain: "ouruiofficial.firebaseapp.com",
      projectId: "ouruiofficial",
      storageBucket: "ouruiofficial.firebasestorage.app",
      messagingSenderId: "513335403025",
      appId: "1:513335403025:web:b965e1187d5386d52d87b0",
      measurementId: "G-X5QWNP8DMK"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Special team user doc id mentioned by you:
    const TEAM_USER_DOC_ID = "ZsH8QfloYOOih3R7cCD6";

    // DOM references
    const accountBtn = document.getElementById('accountBtn');
    const displayNameEl = document.getElementById('displayName');
    const postPrompt = document.getElementById('postPrompt');
    const postBtn = document.getElementById('postBtn');
    const postsContainer = document.getElementById('postsContainer');
    const repliesContainer = document.getElementById('repliesContainer');
    const helpLine = document.getElementById('helpLine');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const navCommunity = document.getElementById('navCommunity');
    const navFeedback = document.getElementById('navFeedback');

    let currentUser = null;

    // Simple UI helpers
    function showModal(html){
      modalContent.innerHTML = html;
      modalBackdrop.style.display = 'flex';
    }
    function closeModal(){ modalBackdrop.style.display = 'none'; modalContent.innerHTML = ''; }

    modalBackdrop.addEventListener('click', (e)=>{
      if(e.target === modalBackdrop) closeModal();
    });

    // Sign in anonymously by default and let user set a display name (no backend)
    auth.onAuthStateChanged(async user => {
      if(user){
        currentUser = user;
        // store a simple profile in firestore if not exist
        const userRef = db.collection('users').doc(user.uid);
        const doc = await userRef.get();
        if(!doc.exists){
          // set a default profile
          await userRef.set({
            displayName: 'User' + user.uid.substring(0,4),
            photoURL: null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        const data = (await userRef.get()).data();
        updateAccountUI(data);
        loadPosts();
        loadReplies();
      } else {
        // sign in anonymously
        auth.signInAnonymously().catch(console.error);
      }
    });

    async function updateAccountUI(profile){
      const name = profile?.displayName || ('User');
      displayNameEl.innerText = name;
      accountBtn.innerText = (profile?.photoURL) ? '' : (name[0] || 'U');
      accountBtn.title = name;
    }

    // Account click -> open account link
    accountBtn.addEventListener('click', ()=> {
      // open in new tab
      window.open('https://account.cynviaone.xo.je', '_blank');
    });

    // Help line -> small popup
    helpLine.addEventListener('click', ()=>{
      showModal(`<div style="font-weight:700;margin-bottom:8px">Privacy & Verification</div>
                 <div>The content uploaded by user may not be verified and for privacy check our <a href="#" onclick="alert('Open privacy policy');return false;">privacy policy</a>.</div>
                 <div style="margin-top:12px;text-align:right"><button onclick="closeModal()" style="padding:8px 12px;border-radius:8px">Close</button></div>`);
    });

    // Post prompt click -> open compose modal
    postPrompt.addEventListener('click', ()=> openComposePost());
    postBtn.addEventListener('click', ()=> openComposePost());

    function openComposePost(){
      showModal(`<div style="font-weight:700;margin-bottom:8px">Create a post</div>
        <textarea id="composeText" placeholder="Write something..." style="width:100%;min-height:120px;padding:8px;border-radius:8px"></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
          <button onclick="closeModal()" style="padding:8px 12px;border-radius:8px">Cancel</button>
          <button id="submitPost" style="padding:8px 12px;border-radius:8px;background:black;color:white">Post</button>
        </div>
      `);
      document.getElementById('submitPost').addEventListener('click', async ()=>{
        const text = document.getElementById('composeText').value.trim();
        if(!text) return alert('Please write something');
        await db.collection('posts').add({
          userId: auth.currentUser.uid,
          displayName: displayNameEl.innerText || ('User'),
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: []
        });
        closeModal();
      });
    }

    // Listen & render posts
    function loadPosts(){
      db.collection('posts').orderBy('createdAt','desc').onSnapshot(snapshot=>{
        postsContainer.innerHTML = '';
        snapshot.forEach(doc=>{
          const p = doc.data();
          const id = doc.id;
          const item = renderPost(id,p);
          postsContainer.appendChild(item);
        });
      });
    }

    function renderPost(id, p){
      const el = document.createElement('div');
      el.className = 'card';
      el.style.marginTop = '12px';
      const createdAt = p.createdAt ? (p.createdAt.toDate().toLocaleString()) : 'Posted date';
      el.innerHTML = `
        <div class="meta">
          <div class="avatar">${(p.displayName||'U')[0]}</div>
          <div>
            <div class="name">${escapeHtml(p.displayName||'Displayname')}</div>
            <div class="date">${createdAt}</div>
          </div>
        </div>
        <div class="post-text">${escapeHtml(p.text)}</div>
        <div class="actions">
          <div class="action-pill like-pill" data-id="${id}">
            <span class="material-icons">thumb_up</span>
            <span class="like-count">${(p.likes||[]).length}</span>
          </div>
          <div class="action-pill reply-pill" data-id="${id}">
            <span class="material-icons">reply</span>
            <span>Add reply</span>
          </div>
        </div>
      `;

      // like click
      const likePill = el.querySelector('.like-pill');
      const replyPill = el.querySelector('.reply-pill');

      // set liked state if user already liked
      const liked = (p.likes||[]).includes(auth.currentUser?.uid);
      if(liked) likePill.classList.add('liked');

      likePill.addEventListener('click', async ()=>{
        const uid = auth.currentUser.uid;
        const ref = db.collection('posts').doc(id);
        const doc = await ref.get();
        const data = doc.data();
        const likes = data.likes || [];
        if(likes.includes(uid)){
          // unlike
          await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(uid) });
        } else {
          await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(uid) });
        }
      });

      replyPill.addEventListener('click', ()=>{
        openReplyModal(id);
      });

      return el;
    }

    function openReplyModal(postId){
      showModal(`<div style="font-weight:700;margin-bottom:8px">Add a reply</div>
        <textarea id="replyText" placeholder="Write your reply..." style="width:100%;min-height:120px;padding:8px;border-radius:8px"></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
          <button onclick="closeModal()" style="padding:8px 12px;border-radius:8px">Cancel</button>
          <button id="submitReply" style="padding:8px 12px;border-radius:8px;background:black;color:white">Reply</button>
        </div>
      `);
      document.getElementById('submitReply').addEventListener('click', async ()=>{
        const text = document.getElementById('replyText').value.trim();
        if(!text) return alert('Please write a reply');
        // Replies stored under collection 'posts/{postId}/replies'
        await db.collection('posts').doc(postId).collection('replies').add({
          userId: auth.currentUser.uid,
          displayName: displayNameEl.innerText || ('User'),
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: []
        });
        closeModal();
      });
    }

    // load latest replies across all posts (flattened)
    function loadReplies(){
      // simple approach: listen to all replies by attaching a listener to posts and then for each collecting replies.
      db.collection('posts').onSnapshot(async snap=>{
        repliesContainer.innerHTML = '';
        // gather all reply snapshots
        const promises = [];
        snap.forEach(postDoc=>{
          const postId = postDoc.id;
          promises.push(db.collection('posts').doc(postId).collection('replies').orderBy('createdAt','desc').get().then(q=>{
            return {postId, docs: q.docs};
          }));
        });
        const results = await Promise.all(promises);
        // flatten and sort by createdAt descending
        let flat = [];
        results.forEach(r=>{
          r.docs.forEach(d=>{
            flat.push({postId: r.postId, id: d.id, data: d.data()});
          });
        });
        flat.sort((a,b)=>{
          const ta = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
          const tb = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
          return tb - ta;
        });
        flat.forEach(item=>{
          const node = renderReply(item.postId, item.id, item.data);
          repliesContainer.appendChild(node);
        });
      });
    }

    function renderReply(postId, id, r){
      const wrapper = document.createElement('div');
      wrapper.className = 'reply';
      wrapper.style.marginTop = '12px';
      // special styling if reply user is the TEAM_USER_DOC_ID
      const isTeam = (r.userId === TEAM_USER_DOC_ID);
      wrapper.innerHTML = `
        <div class="${isTeam ? 'reply-card team-reply' : 'reply-card'}">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
            <div class="avatar">${(r.displayName||'U')[0]}</div>
            <div>
              <div style="display:flex;align-items:center">
                <div style="font-weight:700">${escapeHtml(r.displayName||'Displayname')}</div>
                ${isTeam ? '<div class="verified">✓</div>' : ''}
              </div>
              <div style="color:var(--muted);font-size:13px">${r.createdAt ? r.createdAt.toDate().toLocaleString() : 'Posted date'}</div>
            </div>
          </div>
          <div style="font-weight:700;font-size:18px;margin-bottom:10px">${escapeHtml(r.text)}</div>
          <div>
            <div class="action-pill reply-like" data-post="${postId}" data-id="${id}" style="${isTeam ? 'background:black;color:white' : ''}">
              <span class="material-icons">thumb_up</span>
              <span class="like-count">${(r.likes||[]).length}</span>
            </div>
          </div>
        </div>
      `;
      // like handler
      const likeBtn = wrapper.querySelector('.reply-like');
      likeBtn.addEventListener('click', async ()=>{
        const uid = auth.currentUser.uid;
        const ref = db.collection('posts').doc(postId).collection('replies').doc(id);
        const doc = await ref.get();
        const data = doc.data();
        const likes = data.likes || [];
        if(likes.includes(uid)){
          await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(uid) });
        } else {
          await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(uid) });
        }
      });
      return wrapper;
    }

    // Escape helper
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // bottom nav handlers
    navCommunity.addEventListener('click', ()=> window.open('https://help.cynviaone.xo.je/community','_blank'));
    navFeedback.addEventListener('click', ()=> {
      // nothing happens per your request
    });

    // Re-render like counts in real time for posts & replies using listeners
    db.collection('posts').onSnapshot(async snap=>{
      // already re-rendered by loadPosts but ensure UI updates for likes
      // posts
      snap.forEach(async doc=>{
        const data = doc.data();
        const id = doc.id;
        const el = Array.from(document.querySelectorAll('.like-pill')).find(x => x.getAttribute('data-id') === id);
        if(el){ 
          el.querySelector('.like-count').innerText = (data.likes||[]).length;
          if((data.likes||[]).includes(auth.currentUser?.uid)) el.classList.add('liked'); else el.classList.remove('liked');
        }
        // replies counts for each post
        const repliesSnap = await db.collection('posts').doc(id).collection('replies').get();
        repliesSnap.forEach(rdoc=>{
          const r = rdoc.data();
          const rid = rdoc.id;
          const elr = Array.from(document.querySelectorAll('.reply-like')).find(x=> x.getAttribute('data-id') === rid);
          if(elr) elr.querySelector('.like-count').innerText = (r.likes||[]).length;
        });
      });
    });

    // initial load (in case auth already ready)
    // small helper: allow clicking on display name to change name (local)
    displayNameEl.addEventListener('click', async ()=>{
      const newName = prompt('Set display name', displayNameEl.innerText) || displayNameEl.innerText;
      displayNameEl.innerText = newName;
      await db.collection('users').doc(auth.currentUser.uid).set({ displayName: newName }, { merge:true });
    });

    // simple seed for demo if no posts exist (optional)
    (async function seedDemo(){
      const p = await db.collection('posts').limit(1).get();
      if(p.empty){
        await db.collection('posts').add({
          userId: 'demoUser1',
          displayName: 'Displayname',
          text: 'All text show here',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: []
        });
        // add a reply with team user id to demonstrate the grey box and black like button
        const postSnap = await db.collection('posts').orderBy('createdAt','desc').limit(1).get();
        if(!postSnap.empty){
          const pid = postSnap.docs[0].id;
          // create a reply by a normal user
          await db.collection('posts').doc(pid).collection('replies').add({
            userId: 'demoUser2',
            displayName: 'Displayname',
            text: 'All text show here',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            likes: []
          });
          // create a team reply using the special ID
          await db.collection('posts').doc(pid).collection('replies').add({
            userId: TEAM_USER_DOC_ID,
            displayName: 'Displayname',
            text: 'All text show here',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            likes: []
          });
        }
      }
    })();

  </script>
</body>
</html>
